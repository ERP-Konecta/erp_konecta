name: python-services CI/CD

on:
  push:
    branches: [ai-team-work, main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      services:
        description: 'Comma-separated list of services to deploy'
        required: false
        type: string

jobs:

  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
      has_changes: ${{ steps.set-services.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed service directories
        id: changed-dirs
        if: github.event_name != 'workflow_dispatch'
        uses: tj-actions/changed-files@v44
        with:
          files: |
            chatbot/**
            doc-processing/**
            hr-attrition/**
            prophet-forecast/**
            tft-revenue-forecast/**
          dir_names: true
          dir_names_max_depth: 1

      - name: Set services matrix
        id: set-services
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.services }}" ]; then
            SERVICES=$(echo "${{ inputs.services }}" | jq -Rc 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          else
            DIRS="${{ steps.changed-dirs.outputs.all_changed_files }}"
            if [ -z "$DIRS" ]; then
              SERVICES="[]"
            else
              SERVICES=$(echo "$DIRS" | jq -Rc 'split(" ") | map(select(length > 0))')
            fi
          fi

          COUNT=$(echo "$SERVICES" | jq 'length')
          if [ "$COUNT" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "services=[]" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
          fi

  service-pipeline:
    name: Pipeline for ${{ matrix.service }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}

    permissions:
      contents: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Secret scan with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
          GITLEAKS_NOTIFY_USER_LIST: ${{ secrets.GITLEAKS_NOTIFY_USER_LIST }}
          GITLEAKS_SCAN_PATH: "${{ matrix.service }}"

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: sonar-${{ matrix.service }}

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        continue-on-error: true
        with:
          projectBaseDir: ${{ matrix.service }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        continue-on-error: true
        with:
          scanMetadataReportFile: "${{ matrix.service }}/.scannerwork/report-task.txt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


      - name: Cache OWASP Dependency-Check DB
        uses: actions/cache@v4
        with:
          path: ~/.dependency-check
          key: depcheck-${{ matrix.service }}

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        continue-on-error: true
        with:
          project: ${{ matrix.service }}
          path: ./${{ matrix.service }}
          format: 'ALL'
          out: 'reports-${{ matrix.service }}'

      - name: Upload DepCheck Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: depcheck-${{ matrix.service }}
          path: reports-${{ matrix.service }}


      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Lock dependencies
        working-directory: ./${{ matrix.service }}
        run: uv lock

      - name: Build Docker Image
        run: docker build -t ${{ vars.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ github.run_number }} ./${{ matrix.service }}

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: '${{ vars.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ github.run_number }}'
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'


      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Push Image
        run: docker push ${{ vars.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ github.run_number }}


  
      - name: Update docker-compose image tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin ${{ github.ref_name }}
          sed -i "s|${{ vars.DOCKERHUB_USERNAME }}/${{ matrix.service }}:.*|${{ vars.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ github.run_number }}|g" docker-compose.yml
          git add docker-compose.yml
          git diff-index --quiet HEAD || git commit -m "Update ${{ matrix.service }} tag to ${{ github.run_number }}"
          git push


      - name: Deploy to EC2
        env:
          SERVICE_NAME: ${{ matrix.service }}
          github_run_number: ${{ github.run_number }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: scripts/deploy.sh

      - name: ZAP Scan
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'http://${{ secrets.EC2_HOST }}/${{ matrix.service }}'
          artifact_name: 'zap-${{ matrix.service }}'
          cmd_options: '-a'
